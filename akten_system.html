<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Akten System - Polizei Netzwerk</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9fafb;
    margin: 0; padding: 20px;
    color: #222;
  }
  h1 {
    text-align: center;
  }
  .container {
    max-width: 960px;
    margin: 0 auto;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }
  label {
    font-weight: bold;
  }
  input[type=text], input[type=date], input[type=tel], input[type=number], select, textarea {
    width: 100%;
    padding: 8px 10px;
    margin-top: 4px;
    margin-bottom: 12px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 14px;
  }
  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .row > div {
    flex: 1;
    min-width: 140px;
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  button {
    background-color: #2980b9;
    color: white;
    border: none;
    padding: 10px 18px;
    margin-right: 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.25s ease;
  }
  button:hover {
    background-color: #1a5276;
  }
  #aktenListe {
    margin-top: 30px;
  }
  .akte-item {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  .akte-info {
    flex: 1 1 60%;
  }
  .akte-actions button {
    margin-left: 5px;
  }
  #photoPreview {
    max-width: 120px;
    border-radius: 8px;
    margin-top: 10px;
    display: none;
  }
  #filterInputs {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  #filterInputs > div {
    flex: 1;
    min-width: 180px;
  }
  .log-entry {
    background: #eef6fc;
    border-left: 4px solid #2980b9;
    padding: 8px 12px;
    margin: 5px 0;
    font-size: 13px;
    border-radius: 3px;
  }
  .log-container {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 10px;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 6px;
    background: #fafafa;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Akten System</h1>

  <!-- Schritt 1: Titel + Akte anlegen -->
  <div id="createAkteStep">
    <label for="akteTitel">Akten Titel (Name):</label>
    <input type="text" id="akteTitel" placeholder="Titel der Akte eingeben" />
    <button id="btnCreateAkte">Akte anlegen</button>
  </div>

  <!-- Schritt 2: Akte erweitern -->
  <div id="editAkteStep" style="display:none;">
    <h2>Akte erweitern: <span id="aktTitelAnzeigen"></span> (ID: <span id="aktIdAnzeigen"></span>)</h2>
    <div class="row">
      <div>
        <label for="vorname">Vorname</label>
        <input type="text" id="vorname" />
      </div>
      <div>
        <label for="nachname">Nachname</label>
        <input type="text" id="nachname" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="geschlecht">Geschlecht</label>
        <select id="geschlecht">
          <option value="">-- Bitte wählen --</option>
          <option value="männlich">Männlich</option>
          <option value="weiblich">Weiblich</option>
          <option value="divers">Divers</option>
        </select>
      </div>
      <div>
        <label for="geburtsdatum">Geburtsdatum</label>
        <input type="date" id="geburtsdatum" />
      </div>
      <div>
        <label for="telefonnummer">Telefonnummer</label>
        <input type="tel" id="telefonnummer" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="groesse">Größe (cm)</label>
        <input type="number" id="groesse" min="30" max="300" />
      </div>
      <div>
        <label for="augenfarbe">Augenfarbe</label>
        <input type="text" id="augenfarbe" />
      </div>
      <div>
        <label for="haarfarbe">Haarfarbe</label>
        <input type="text" id="haarfarbe" />
      </div>
    </div>
    <div>
      <label for="sonstiges">Sonstiges</label>
      <textarea id="sonstiges" placeholder="Weitere Informationen"></textarea>
    </div>

    <hr style="margin: 20px 0;" />

    <!-- Straftat / Vermerk Auswahl -->
    <label for="eintragTyp">Eintrag hinzufügen:</label>
    <select id="eintragTyp">
      <option value="">-- auswählen --</option>
      <option value="straftat">Straftat</option>
      <option value="vermerk">Vermerk</option>
    </select>

    <div id="straftatBereich" style="display:none; margin-top:10px;">
      <label for="straftatText">Straftat Beschreibung:</label>
      <textarea id="straftatText"></textarea>
    </div>

    <div id="vermerkBereich" style="display:none; margin-top:10px;">
      <label for="vermerkText">Vermerk Beschreibung:</label>
      <textarea id="vermerkText"></textarea>
    </div>

    <div style="margin-top: 15px;">
      <label for="fotoInput">Foto hochladen:</label>
      <input type="file" id="fotoInput" accept="image/*" />
      <img id="photoPreview" alt="Foto Vorschau" />
    </div>

    <div style="margin-top: 20px;">
      <button id="btnAddEntry">Eintrag speichern</button>
      <button id="btnFertig">Fertig</button>
      <button id="btnAbbrechen">Abbrechen</button>
    </div>

    <!-- Log Verlauf -->
    <h3>Bearbeitungsverlauf</h3>
    <div class="log-container" id="logContainer"></div>
  </div>

  <hr style="margin: 30px 0;" />

  <!-- Filter Bereich -->
  <div id="filterInputs">
    <div>
      <label for="filterName">Nach Name filtern:</label>
      <input type="text" id="filterName" placeholder="Vor- oder Nachname suchen" />
    </div>
    <div>
      <label for="filterErsteller">Nach Ersteller filtern:</label>
      <input type="text" id="filterErsteller" placeholder="Erstellername suchen" />
    </div>
  </div>

  <!-- Akten Liste -->
  <div id="aktenListe">
    <h2>Gespeicherte Akten</h2>
    <div id="aktenContainer"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase Config & Init
  const firebaseConfig = {
    apiKey: "AIzaSyAE4nCkJkdR8P9EKyEILHF8CN4pbRUTrHM",
    authDomain: "copnet-berlinrp.firebaseapp.com",
    projectId: "copnet-berlinrp",
    storageBucket: "copnet-berlinrp.appspot.com",
    messagingSenderId: "325379817013",
    appId: "1:325379817013:web:0367b33aeeaf92372786b1",
    measurementId: "G-PRRM4NY7EG"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let aktuelleAkteId = null;
  let aktuelleAkteTitel = "";

  // UI Referenzen
  const createStep = document.getElementById("createAkteStep");
  const editStep = document.getElementById("editAkteStep");
  const akteTitelInput = document.getElementById("akteTitel");
  const btnCreateAkte = document.getElementById("btnCreateAkte");
  const aktTitelAnzeigen = document.getElementById("aktTitelAnzeigen");
  const aktIdAnzeigen = document.getElementById("aktIdAnzeigen");

  const vornameInput = document.getElementById("vorname");
  const nachnameInput = document.getElementById("nachname");
  const geschlechtSelect = document.getElementById("geschlecht");
  const geburtsdatumInput = document.getElementById("geburtsdatum");
  const telefonnummerInput = document.getElementById("telefonnummer");
  const groesseInput = document.getElementById("groesse");
  const augenfarbeInput = document.getElementById("augenfarbe");
  const haarfarbeInput = document.getElementById("haarfarbe");
  const sonstigesInput = document.getElementById("sonstiges");

  const eintragTypSelect = document.getElementById("eintragTyp");
  const strraftatBereich = document.getElementById("straftatBereich");
  const vermerkBereich = document.getElementById("vermerkBereich");
  const strraftatText = document.getElementById("straftatText");
  const vermerkText = document.getElementById("vermerkText");

  const fotoInput = document.getElementById("fotoInput");
  const photoPreview = document.getElementById("photoPreview");

  const btnAddEntry = document.getElementById("btnAddEntry");
  const btnFertig = document.getElementById("btnFertig");
  const btnAbbrechen = document.getElementById("btnAbbrechen");

  const logContainer = document.getElementById("logContainer");

  const aktenContainer = document.getElementById("aktenContainer");

  const filterNameInput = document.getElementById("filterName");
  const filterErstellerInput = document.getElementById("filterErsteller");

  // Funktionen

  // Akte anlegen
  btnCreateAkte.addEventListener("click", () => {
    const titel = akteTitelInput.value.trim();
    if(!titel) {
      alert("Bitte einen Akten-Titel eingeben.");
      return;
    }

    // Neue Akte in Firestore anlegen
    db.collection("akten").add({
      titel: titel,
      erstelltAm: new Date(),
      ersteller: "BenutzerXYZ", // TODO: Dynamisch ggf.
      daten: {},
      eintraege: [],
      bearbeitungsLog: []
    }).then(docRef => {
      aktuelleAkteId = docRef.id;
      aktuelleAkteTitel = titel;
      showEditStep();
      clearEditForm();
      logBearbeitung("Akte erstellt.");
      loadAktenListe();
    }).catch(err => {
      alert("Fehler beim Erstellen der Akte: " + err.message);
    });
  });

  // Anzeige wechseln zu Bearbeiten
  function showEditStep() {
    createStep.style.display = "none";
    editStep.style.display = "block";
    aktTitelAnzeigen.textContent = aktuelleAkteTitel;
    aktIdAnzeigen.textContent = aktuelleAkteId;
  }
  // Anzeige wechseln zu Erstellen
  function showCreateStep() {
    createStep.style.display = "block";
    editStep.style.display = "none";
  }

  // Formularfelder leeren
  function clearEditForm() {
    vornameInput.value = "";
    nachnameInput.value = "";
    geschlechtSelect.value = "";
    geburtsdatumInput.value = "";
    telefonnummerInput.value = "";
    groesseInput.value = "";
    augenfarbeInput.value = "";
    haarfarbeInput.value = "";
    sonstigesInput.value = "";
    eintragTypSelect.value = "";
    strraftatBereich.style.display = "none";
    vermerkBereich.style.display = "none";
    strraftatText.value = "";
    vermerkText.value = "";
    fotoInput.value = "";
    photoPreview.src = "";
    photoPreview.style.display = "none";
  }

  // Eintragtyp ändern: je nach Auswahl Textarea zeigen
  eintragTypSelect.addEventListener("change", () => {
    const wert = eintragTypSelect.value;
    if(wert === "straftat") {
      strraftatBereich.style.display = "block";
      vermerkBereich.style.display = "none";
    } else if(wert === "vermerk") {
      strraftatBereich.style.display = "none";
      vermerkBereich.style.display = "block";
    } else {
      strraftatBereich.style.display = "none";
      vermerkBereich.style.display = "none";
    }
  });

  // Foto Preview anzeigen
  fotoInput.addEventListener("change", () => {
    const file = fotoInput.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = e => {
        photoPreview.src = e.target.result;
        photoPreview.style.display = "block";
      }
      reader.readAsDataURL(file);
    } else {
      photoPreview.src = "";
      photoPreview.style.display = "none";
    }
  });

  // Bearbeitungsverlauf loggen
  function logBearbeitung(text) {
    const zeit = new Date().toLocaleString();
    const eintrag = `[${zeit}] ${text}`;
    const div = document.createElement("div");
    div.className = "log-entry";
    div.textContent = eintrag;
    logContainer.appendChild(div);
    logContainer.scrollTop = logContainer.scrollHeight;

    // Auch in Firestore speichern
    db.collection("akten").doc(aktuelleAkteId).update({
      bearbeitungsLog: firebase.firestore.FieldValue.arrayUnion(eintrag)
    });
  }

  // Eintrag speichern
  btnAddEntry.addEventListener("click", async () => {
    if(!aktuelleAkteId) {
      alert("Keine Akte ausgewählt.");
      return;
    }

    // Grunddaten speichern
    const daten = {
      vorname: vornameInput.value.trim(),
      nachname: nachnameInput.value.trim(),
      geschlecht: geschlechtSelect.value,
      geburtsdatum: geburtsdatumInput.value,
      telefonnummer: telefonnummerInput.value.trim(),
      groesse: groesseInput.value,
      augenfarbe: augenfarbeInput.value.trim(),
      haarfarbe: haarfarbeInput.value.trim(),
      sonstiges: sonstigesInput.value.trim()
    };

    // Eintragstyp prüfen und Text
    const eintragTyp = eintragTypSelect.value;
    let eintragText = "";
    if(eintragTyp === "straftat") {
      eintragText = strraftatText.value.trim();
      if(!eintragText) {
        alert("Bitte eine Straftat Beschreibung eingeben.");
        return;
      }
    } else if(eintragTyp === "vermerk") {
      eintragText = vermerkText.value.trim();
      if(!eintragText) {
        alert("Bitte einen Vermerk eingeben.");
        return;
      }
    } else {
      alert("Bitte einen Eintragstyp auswählen.");
      return;
    }

    // Foto (Base64)
    let fotoData = null;
    if(fotoInput.files.length > 0) {
      const file = fotoInput.files[0];
      fotoData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    // Eintrag erstellen
    const neuerEintrag = {
      typ: eintragTyp,
      text: eintragText,
      foto: fotoData,
      erstelltAm: new Date().toISOString()
    };

    // Update in Firestore
    try {
      await db.collection("akten").doc(aktuelleAkteId).update({
        daten: daten,
        eintraege: firebase.firestore.FieldValue.arrayUnion(neuerEintrag)
      });
      logBearbeitung(`Eintrag (${eintragTyp}) hinzugefügt.`);
      clearEditForm();
    } catch(err) {
      alert("Fehler beim Speichern: " + err.message);
    }
  });

  // Fertig Button: zurück zur Aktenübersicht
  btnFertig.addEventListener("click", () => {
    aktuelleAkteId = null;
    aktuelleAkteTitel = "";
    clearEditForm();
    logContainer.innerHTML = "";
    showCreateStep();
    loadAktenListe();
  });

  // Abbrechen Button: Formular leeren und zurück
  btnAbbrechen.addEventListener("click", () => {
    if(confirm("Sollen die Änderungen verworfen werden?")) {
      aktuelleAkteId = null;
      aktuelleAkteTitel = "";
      clearEditForm();
      logContainer.innerHTML = "";
      showCreateStep();
    }
  });

  // Akten laden und anzeigen
  async function loadAktenListe() {
    aktenContainer.innerHTML = "<p>Lade Akten...</p>";
    try {
      let query = db.collection("akten").orderBy("erstelltAm", "desc");
      const snapshot = await query.get();

      const alleAkten = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        alleAkten.push({ id: doc.id, ...data });
      });

      // Filter anwenden
      const filterName = filterNameInput.value.trim().toLowerCase();
      const filterErsteller = filterErstellerInput.value.trim().toLowerCase();

      const gefiltert = alleAkten.filter(a => {
        const nameCheck = !filterName || 
          (a.daten.vorname && a.daten.vorname.toLowerCase().includes(filterName)) || 
          (a.daten.nachname && a.daten.nachname.toLowerCase().includes(filterName));
        const erstellerCheck = !filterErsteller || (a.ersteller && a.ersteller.toLowerCase().includes(filterErsteller));
        return nameCheck && erstellerCheck;
      });

      if(gefiltert.length === 0) {
        aktenContainer.innerHTML = "<p>Keine Akten gefunden.</p>";
        return;
      }

      aktenContainer.innerHTML = "";

      gefiltert.forEach(akte => {
        const div = document.createElement("div");
        div.className = "akte-item";

        // Info Text
        const infoDiv = document.createElement("div");
        infoDiv.className = "akte-info";
        infoDiv.innerHTML = `
          <strong>${akte.titel}</strong><br />
          ID: ${akte.id}<br />
          Name: ${akte.daten.vorname || ""} ${akte.daten.nachname || ""}<br />
          Ersteller: ${akte.ersteller || "Unbekannt"}<br />
          Einträge: ${akte.eintraege ? akte.eintraege.length : 0}
        `;
        div.appendChild(infoDiv);

        // Aktionen
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "akte-actions";

        // Bearbeiten Button
        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Bearbeiten";
        btnEdit.addEventListener("click", () => {
          aktuelleAkteId = akte.id;
          aktuelleAkteTitel = akte.titel;
          showEditStep();

          // Formular mit aktuellen Daten befüllen
          vornameInput.value = akte.daten.vorname || "";
          nachnameInput.value = akte.daten.nachname || "";
          geschlechtSelect.value = akte.daten.geschlecht || "";
          geburtsdatumInput.value = akte.daten.geburtsdatum || "";
          telefonnummerInput.value = akte.daten.telefonnummer || "";
          groesseInput.value = akte.daten.groesse || "";
          augenfarbeInput.value = akte.daten.augenfarbe || "";
          haarfarbeInput.value = akte.daten.haarfarbe || "";
          sonstigesInput.value = akte.daten.sonstiges || "";

          // Log anzeigen
          logContainer.innerHTML = "";
          if(akte.bearbeitungsLog && akte.bearbeitungsLog.length > 0) {
            akte.bearbeitungsLog.forEach(e => {
              const div = document.createElement("div");
              div.className = "log-entry";
              div.textContent = e;
              logContainer.appendChild(div);
            });
            logContainer.scrollTop = logContainer.scrollHeight;
          }
        });
        actionsDiv.appendChild(btnEdit);

        // Löschen Button
        const btnDelete = document.createElement("button");
        btnDelete.textContent = "Löschen";
        btnDelete.style.backgroundColor = "#c0392b";
        btnDelete.addEventListener("click", () => {
          if(confirm(`Akte "${akte.titel}" wirklich löschen?`)) {
            db.collection("akten").doc(akte.id).delete()
              .then(() => {
                alert("Akte gelöscht.");
                loadAktenListe();
              })
              .catch(err => {
                alert("Fehler beim Löschen: " + err.message);
              });
          }
        });
        actionsDiv.appendChild(btnDelete);

        div.appendChild(actionsDiv);

        aktenContainer.appendChild(div);
      });
    } catch(err) {
      aktenContainer.innerHTML = "<p>Fehler beim Laden: " + err.message + "</p>";
    }
  }

  // Filter Eingaben mit Verzögerung auslösen
  let filterTimeout;
  filterNameInput.addEventListener("input", () => {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(loadAktenListe, 400);
  });
  filterErstellerInput.addEventListener("input", () => {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(loadAktenListe, 400);
  });

  // Initial laden
  loadAktenListe();

</script>
</body>
</html>

